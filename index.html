<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#d97706">
  <meta name="description" content="Daily Scripture Memory App - Memorize Bible verses offline">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Scripture">
  
  <title>Daily Scripture Memory</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }

    // App State
    let state = {
      passages: [],
      currentIndex: 0,
      showAddForm: false,
      showLibrary: false,
      newReference: '',
      newText: '',
      isPlaying: false,
      voices: [],
      selectedVoice: '',
      loading: true,
      deleteConfirm: null,
      viewingPassage: null,
      showImportExport: false,
      importText: '',
      editingPassage: null,
      editReference: '',
      editText: '',
      showNextConfirm: false,
      alphabeticalView: false,
      sortOrder: 'asc'
    };

    // Load voices
    function loadVoices() {
      if (!window.speechSynthesis) return;
      
      const synth = window.speechSynthesis;
      const loadVoiceList = () => {
        try {
          const availableVoices = synth.getVoices();
          state.voices = availableVoices;
          if (availableVoices.length > 0 && !state.selectedVoice) {
            const markVoice = availableVoices.find(v => v.name.includes('Microsoft Mark'));
            state.selectedVoice = markVoice ? markVoice.name : availableVoices[0].name;
          }
          render();
        } catch (error) {
          console.error('Voice loading error:', error);
        }
      };
      
      loadVoiceList();
      setTimeout(loadVoiceList, 100);
      
      if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = loadVoiceList;
      }
    }

    // Load data
    function loadData() {
      try {
        const savedPassages = localStorage.getItem('scripture-passages');
        const savedIndex = localStorage.getItem('scripture-current-index');
        
        if (savedPassages) {
          state.passages = JSON.parse(savedPassages);
        }
        if (savedIndex) {
          state.currentIndex = parseInt(savedIndex);
        }
      } catch (error) {
        console.log('Error loading from localStorage:', error);
      }
      state.loading = false;
      render();
    }

    // Save passages
    function savePassages(newPassages, newIndex = null) {
      try {
        localStorage.setItem('scripture-passages', JSON.stringify(newPassages));
        if (newIndex !== null) {
          localStorage.setItem('scripture-current-index', newIndex.toString());
          state.currentIndex = newIndex;
        }
      } catch (error) {
        console.error('Error saving to localStorage:', error);
      }
    }

    // Add passage
    function addPassage() {
      if (!state.newReference.trim() || !state.newText.trim()) return;
      
      const newPassage = {
        id: Date.now(),
        reference: state.newReference.trim(),
        text: state.newText.trim(),
        addedDate: new Date().toDateString()
      };
      
      const insertPosition = state.currentIndex + 1;
      const updatedPassages = [
        ...state.passages.slice(0, insertPosition),
        newPassage,
        ...state.passages.slice(insertPosition)
      ];
      
      state.passages = updatedPassages;
      savePassages(updatedPassages);
      state.newReference = '';
      state.newText = '';
      state.showAddForm = false;
      render();
    }

    // Delete passage
    function deletePassage(id) {
      const updatedPassages = state.passages.filter(p => p.id !== id);
      state.passages = updatedPassages;
      let newIndex = state.currentIndex;
      if (state.currentIndex >= updatedPassages.length) {
        newIndex = Math.max(0, updatedPassages.length - 1);
      }
      savePassages(updatedPassages, newIndex);
      state.deleteConfirm = null;
      render();
    }

    // Edit passage
    function handleEditClick(passage) {
      state.editingPassage = passage;
      state.editReference = passage.reference;
      state.editText = passage.text;
      render();
    }

    function saveEdit() {
      if (!state.editReference.trim() || !state.editText.trim()) return;
      
      const updatedPassages = state.passages.map(p => 
        p.id === state.editingPassage.id 
          ? { ...p, reference: state.editReference.trim(), text: state.editText.trim() }
          : p
      );
      
      state.passages = updatedPassages;
      savePassages(updatedPassages);
      
      if (state.viewingPassage?.id === state.editingPassage.id) {
        state.viewingPassage = {
          ...state.viewingPassage,
          reference: state.editReference.trim(),
          text: state.editText.trim()
        };
      }
      
      state.editingPassage = null;
      state.editReference = '';
      state.editText = '';
      render();
    }

    // Move to next passage
    function moveToNextPassage() {
      if (state.passages.length === 0) return;
      const newIndex = (state.currentIndex + 1) % state.passages.length;
      state.currentIndex = newIndex;
      state.viewingPassage = null;
      localStorage.setItem('scripture-current-index', newIndex.toString());
      state.showNextConfirm = false;
      render();
    }

    // Get sorted passages
    function getSortedPassages() {
      if (!state.alphabeticalView) return state.passages;
      const sorted = [...state.passages].sort((a, b) => {
        const refA = a.reference.toLowerCase();
        const refB = b.reference.toLowerCase();
        return state.sortOrder === 'asc' ? refA.localeCompare(refB) : refB.localeCompare(refA);
      });
      return sorted;
    }

    // Export passages
    function exportPassages() {
      try {
        const exportData = {
          passages: state.passages.map(p => ({ reference: p.reference, text: p.text })),
          exportDate: new Date().toISOString()
        };
        const dataStr = JSON.stringify(exportData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `scripture-passages-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Export error:', error);
        alert('Error exporting passages.');
      }
    }

    // Import passages
    function importPassages() {
      try {
        const importData = JSON.parse(state.importText);
        if (!importData.passages || !Array.isArray(importData.passages)) {
          alert('Invalid file format.');
          return;
        }
        const today = new Date().toDateString();
        const importedPassages = importData.passages.map((p, index) => ({
          id: Date.now() + index,
          reference: p.reference,
          text: p.text,
          addedDate: today
        }));
        state.passages = importedPassages;
        savePassages(importedPassages, 0);
        state.importText = '';
        state.showImportExport = false;
        alert(`Successfully imported ${importedPassages.length} passages!`);
        render();
      } catch (error) {
        alert('Error importing passages.');
        console.error(error);
      }
    }

    // File upload handler
    function handleFileUpload(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const importData = JSON.parse(e.target.result);
          if (!importData.passages || !Array.isArray(importData.passages)) {
            alert('Invalid file format.');
            return;
          }
          const today = new Date().toDateString();
          const importedPassages = importData.passages.map((p, index) => ({
            id: Date.now() + index,
            reference: p.reference,
            text: p.text,
            addedDate: today
          }));
          state.passages = importedPassages;
          savePassages(importedPassages, 0);
          state.showImportExport = false;
          alert(`Successfully imported ${importedPassages.length} passages!`);
          render();
        } catch (error) {
          alert('Error importing passages. Please check the file format.');
          console.error(error);
        }
      };
      reader.readAsText(file);
    }

    // Play audio
    function playAudio() {
      if (state.passages.length === 0 || !window.speechSynthesis) return;
      
      const synth = window.speechSynthesis;
      if (state.isPlaying) {
        synth.cancel();
        state.isPlaying = false;
        render();
        return;
      }
      
      try {
        const passageToPlay = state.viewingPassage || state.passages[state.currentIndex];
        const textToSpeak = `${passageToPlay.reference}. ${passageToPlay.text}`;
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        
        if (state.voices.length > 0) {
          const voice = state.voices.find(v => v.name === state.selectedVoice);
          if (voice) utterance.voice = voice;
        }
        
        utterance.onend = () => {
          state.isPlaying = false;
          render();
        };
        utterance.onerror = (e) => {
          console.error('Speech error:', e);
          state.isPlaying = false;
          render();
        };
        
        state.isPlaying = true;
        render();
        synth.speak(utterance);
      } catch (error) {
        console.error('Playback error:', error);
        state.isPlaying = false;
        render();
      }
    }

    // SVG Icons (simplified)
    function createIcon(name, size = 18) {
      const icons = {
        volume: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`,
        pause: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`,
        plus: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
        list: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`,
        x: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
        edit: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
        check: `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>`
      };
      return icons[name] || '';
    }

    // Render function
    function render() {
      const root = document.getElementById('root');
      
      if (state.loading) {
        root.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center">
            <div class="text-xl text-amber-800">Loading...</div>
          </div>
        `;
        return;
      }

      const currentPassage = state.viewingPassage || (state.passages.length > 0 ? state.passages[state.currentIndex] : null);
      const isViewingMode = state.viewingPassage !== null;

      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 p-3 sm:p-4">
          <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-4 sm:mb-8 pt-4 sm:pt-8">
              <div class="flex items-center justify-center gap-3 mb-1 sm:mb-2">
                <h1 class="text-3xl sm:text-4xl font-bold text-amber-900">Daily Scripture</h1>
                ${!isViewingMode && state.passages.length > 0 ? `
                  <button onclick="state.showNextConfirm = true; render();" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-full transition-colors shadow-lg" title="Mark as memorized">
                    ${createIcon('check', 24)}
                  </button>
                ` : ''}
              </div>
              <p class="text-sm sm:text-base text-amber-700">
                ${isViewingMode ? `Viewing ${currentPassage?.reference}` : 'Current Passage'}
              </p>
              ${isViewingMode ? `
                <button onclick="state.viewingPassage = null; render();" class="mt-2 text-xs sm:text-sm text-amber-600 hover:text-amber-800 underline">
                  Return to today's passage
                </button>
              ` : ''}
            </div>

            <!-- Main Content Card -->
            <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl p-4 sm:p-8 mb-4 sm:mb-6">
              ${currentPassage ? `
                <div class="text-center mb-4 sm:mb-6 relative">
                  <button onclick="handleEditClick(${JSON.stringify(currentPassage).replace(/"/g, '&quot;')})" class="absolute top-0 right-0 text-blue-500 hover:text-blue-700 transition-colors" title="Edit">
                    ${createIcon('edit', 20)}
                  </button>
                  <h2 class="text-xl sm:text-2xl font-semibold text-amber-900 mb-3 sm:mb-4 pr-8">
                    ${currentPassage.reference}
                  </h2>
                  <p class="text-base sm:text-lg text-gray-700 leading-relaxed">
                    ${currentPassage.text}
                  </p>
                </div>
                <div class="border-t pt-4 sm:pt-6 space-y-3 sm:space-y-4">
                  ${state.voices.length > 0 ? `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3">
                      <label class="text-sm font-medium text-gray-700">Voice:</label>
                      <select onchange="state.selectedVoice = this.value; render();" class="w-full sm:flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-sm">
                        ${state.voices.map(voice => `
                          <option value="${voice.name}" ${voice.name === state.selectedVoice ? 'selected' : ''}>
                            ${voice.name} (${voice.lang})
                          </option>
                        `).join('')}
                      </select>
                    </div>
                  ` : ''}
                  <button onclick="playAudio()" class="w-full flex items-center justify-center gap-2 bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-lg transition-colors text-sm sm:text-base">
                    ${state.isPlaying ? `${createIcon('pause', 18)} Stop Audio` : `${createIcon('volume', 18)} Play Audio`}
                  </button>
                </div>
              ` : `
                <div class="text-center text-gray-500 py-8 sm:py-12">
                  <p class="mb-3 sm:mb-4">No passages yet</p>
                  <p class="text-sm">Add your first Scripture passage</p>
                </div>
              `}
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6">
              <button onclick="state.showAddForm = !state.showAddForm; render();" class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white py-2.5 sm:py-3 rounded-lg transition-colors text-sm sm:text-base">
                ${createIcon('plus', 18)} Add
              </button>
              <button onclick="state.showLibrary = !state.showLibrary; render();" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-2.5 sm:py-3 rounded-lg transition-colors text-sm sm:text-base">
                ${createIcon('list', 18)} Library (${state.passages.length})
              </button>
              <button onclick="exportPassages()" ${state.passages.length === 0 ? 'disabled' : ''} class="flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white py-2.5 sm:py-3 rounded-lg transition-colors text-sm sm:text-base">
                Export
              </button>
              <button onclick="state.showImportExport = !state.showImportExport; render();" class="flex items-center justify-center gap-2 bg-orange-600 hover:bg-orange-700 text-white py-2.5 sm:py-3 rounded-lg transition-colors text-sm sm:text-base">
                Import
              </button>
            </div>

            <!-- Add Form -->
            ${state.showAddForm ? `
              <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl p-4 sm:p-6 mb-4 sm:mb-6">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3 sm:mb-4">Add New Passage</h3>
                <div class="space-y-3 sm:space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reference</label>
                    <input type="text" value="${state.newReference}" oninput="state.newReference = this.value" placeholder="e.g., John 3:16" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-sm sm:text-base">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Text</label>
                    <textarea oninput="state.newText = this.value" placeholder="Enter the Scripture text..." rows="4" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-sm sm:text-base">${state.newText}</textarea>
                  </div>
                  <div class="flex gap-3">
                    <button onclick="addPassage()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors text-sm sm:text-base">Add</button>
                    <button onclick="state.showAddForm = false; render();" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg transition-colors text-sm sm:text-base">Cancel</button>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Import/Export Form -->
            ${state.showImportExport ? `
              <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl p-4 sm:p-6 mb-4 sm:mb-6">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3 sm:mb-4">Import Passages</h3>
                
                <div class="mb-4">
                  <label class="block w-full">
                    <div class="flex items-center justify-center gap-2 bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-lg transition-colors cursor-pointer text-sm sm:text-base">
                      ${createIcon('plus', 18)} Choose File to Import
                    </div>
                    <input type="file" accept=".json" onchange="handleFileUpload(event)" class="hidden">
                  </label>
                </div>

                <div class="relative my-4">
                  <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                  </div>
                  <div class="relative flex justify-center text-xs sm:text-sm">
                    <span class="px-2 bg-white text-gray-500">or paste JSON manually</span>
                  </div>
                </div>

                <div class="space-y-3 sm:space-y-4">
                  <textarea oninput="state.importText = this.value" placeholder="Paste JSON here..." rows="6" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 text-xs sm:text-sm font-mono">${state.importText}</textarea>
                  <div class="flex gap-3">
                    <button onclick="importPassages()" ${!state.importText.trim() ? 'disabled' : ''} class="flex-1 bg-orange-600 hover:bg-orange-700 disabled:bg-gray-400 text-white py-2 rounded-lg transition-colors text-sm sm:text-base">Import from Text</button>
                    <button onclick="state.showImportExport = false; state.importText = ''; render();" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg transition-colors text-sm sm:text-base">Cancel</button>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Library View -->
            ${state.showLibrary ? `
              <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl p-4 sm:p-6">
                <div class="flex items-center justify-between mb-3 sm:mb-4">
                  <h3 class="text-lg sm:text-xl font-semibold text-gray-800">
                    ${state.alphabeticalView ? 'References Alphabetically' : 'Your Library'}
                  </h3>
                  ${state.alphabeticalView ? `
                    <button onclick="state.alphabeticalView = false; render();" class="text-sm sm:text-base bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg">Normal View</button>
                  ` : `
                    <button onclick="state.alphabeticalView = true; render();" class="text-sm sm:text-base bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-lg">A-Z</button>
                  `}
                </div>
                ${state.passages.length === 0 ? `
                  <p class="text-gray-500 text-center py-4 text-sm sm:text-base">No passages yet</p>
                ` : state.alphabeticalView ? `
                  <div class="flex justify-end mb-3">
                    <button onclick="state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc'; render();" class="text-xs sm:text-sm text-purple-600 hover:text-purple-800 underline">
                      Sort ${state.sortOrder === 'asc' ? 'Z to A' : 'A to Z'}
                    </button>
                  </div>
                  <div class="space-y-2">
                    ${getSortedPassages().map(passage => `
                      <div class="p-3 rounded-lg border border-gray-200 hover:border-purple-300 hover:bg-purple-50 transition-all flex items-center justify-between gap-2">
                        <p onclick="state.viewingPassage = ${JSON.stringify(passage).replace(/"/g, '&quot;')}; state.showLibrary = false; render();" class="font-medium text-gray-800 text-sm sm:text-base flex-1 cursor-pointer">
                          ${passage.reference}
                        </p>
                        <button onclick="state.deleteConfirm = ${JSON.stringify(passage).replace(/"/g, '&quot;')}; render();" class="text-red-500 hover:text-red-700 transition-colors flex-shrink-0">
                          ${createIcon('x', 18)}
                        </button>
                      </div>
                    `).join('')}
                  </div>
                ` : `
                  <div class="space-y-2 sm:space-y-3">
                    ${state.passages.map((passage, index) => {
                      const isCurrent = index === state.currentIndex && !state.viewingPassage;
                      const isViewing = state.viewingPassage?.id === passage.id;
                      return `
                        <div onclick="state.viewingPassage = ${JSON.stringify(passage).replace(/"/g, '&quot;')}; state.showLibrary = false; render();" class="p-3 sm:p-4 rounded-lg border-2 cursor-pointer transition-all hover:shadow-md ${isCurrent ? 'border-amber-500 bg-amber-50' : isViewing ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}">
                          <div class="flex justify-between items-start gap-2">
                            <div class="flex-1 min-w-0">
                              <h4 class="font-semibold text-gray-800 text-sm sm:text-base">${passage.reference}</h4>
                              <p class="text-xs sm:text-sm text-gray-600 mt-1 line-clamp-2">${passage.text}</p>
                              ${isCurrent ? `
                                <span class="inline-block mt-2 text-xs font-medium text-amber-700 bg-amber-100 px-2 py-1 rounded">Current Passage</span>
                              ` : ''}
                              ${isViewing ? `
                                <span class="inline-block mt-2 text-xs font-medium text-blue-700 bg-blue-100 px-2 py-1 rounded">Currently Viewing</span>
                              ` : ''}
                            </div>
                            <div class="flex gap-2 flex-shrink-0">
                              <button onclick="event.stopPropagation(); handleEditClick(${JSON.stringify(passage).replace(/"/g, '&quot;')})" class="text-blue-500 hover:text-blue-700 transition-colors">
                                ${createIcon('edit', 18)}
                              </button>
                              <button onclick="event.stopPropagation(); state.deleteConfirm = ${JSON.stringify(passage).replace(/"/g, '&quot;')}; render();" class="text-red-500 hover:text-red-700 transition-colors">
                                ${createIcon('x', 18)}
                              </button>
                            </div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                `}
              </div>
            ` : ''}
          </div>
        </div>

        <!-- Modals -->
        ${state.showNextConfirm ? `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
              <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Move to Next Passage?</h3>
              <p class="text-sm sm:text-base text-gray-600 mb-4">Would you like to move on to the next verse?</p>
              <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                <p class="font-semibold text-green-900 text-sm sm:text-base mb-1">Current: ${state.passages[state.currentIndex]?.reference}</p>
                ${state.passages.length > 1 ? `<p class="text-xs sm:text-sm text-gray-700">Next: ${state.passages[(state.currentIndex + 1) % state.passages.length]?.reference}</p>` : ''}
              </div>
              <div class="flex gap-3">
                <button onclick="state.showNextConfirm = false; render();" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2.5 rounded-lg text-sm sm:text-base font-medium">Not Yet</button>
                <button onclick="moveToNextPassage()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2.5 rounded-lg text-sm sm:text-base font-medium">Yes, Move On</button>
              </div>
            </div>
          </div>
        ` : ''}

        ${state.editingPassage ? `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
              <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">Edit Passage</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Reference</label>
                  <input type="text" value="${state.editReference}" oninput="state.editReference = this.value" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Text</label>
                  <textarea oninput="state.editText = this.value" rows="6" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">${state.editText}</textarea>
                </div>
                <div class="flex gap-3">
                  <button onclick="state.editingPassage = null; state.editReference = ''; state.editText = ''; render();" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2.5 rounded-lg text-sm sm:text-base font-medium">Cancel</button>
                  <button onclick="saveEdit()" ${!state.editReference.trim() || !state.editText.trim() ? 'disabled' : ''} class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white py-2.5 rounded-lg text-sm sm:text-base font-medium">Save</button>
                </div>
              </div>
            </div>
          </div>
        ` : ''}

        ${state.deleteConfirm ? `
          <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
              <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3">Delete Passage?</h3>
              <p class="text-sm sm:text-base text-gray-600 mb-2">Are you sure you want to delete this passage?</p>
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                <p class="font-semibold text-amber-900 text-sm sm:text-base mb-1">${state.deleteConfirm.reference}</p>
                <p class="text-xs sm:text-sm text-gray-700 line-clamp-2">${state.deleteConfirm.text}</p>
              </div>
              <div class="flex gap-3">
                <button onclick="state.deleteConfirm = null; render();" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2.5 rounded-lg text-sm sm:text-base font-medium">Cancel</button>
                <button onclick="deletePassage(${state.deleteConfirm.id})" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg text-sm sm:text-base font-medium">Delete</button>
              </div>
            </div>
          </div>
        ` : ''}
      `;
    }

    // Initialize
    loadData();
    loadVoices();
  </script>
</body>
</html>
